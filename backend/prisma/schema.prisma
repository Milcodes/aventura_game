// Prisma Schema for Aventura Game Backend

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stories  Story[]
  sessions GameSession[]

  @@map("users")
}

// Story model (user-created stories)
model Story {
  id          String      @id @default(uuid())
  title       String
  description String?
  language    String      @default("hu")
  version     Int         @default(1)
  status      StoryStatus @default(DRAFT)
  isPublic    Boolean     @default(false) // Public = forkable
  content     Json?       // Legacy: Full story JSON (optional)
  authorId    String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  author   User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  sessions GameSession[]
  nodes    StoryNode[]
  branches Branch[]

  @@index([authorId])
  @@index([status])
  @@index([isPublic])
  @@map("stories")
}

enum StoryStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

// Story Node (both mainline and branch nodes)
model StoryNode {
  id         String   @id @default(uuid())
  storyId    String
  branchId   String? // null = mainline, set = branch node
  order      Int // Position in sequence
  label      String // "Születés", "Gyerekkor", "Barna Szoba belül"

  // Content
  mediaType  String? // "image", "video", "text"
  mediaUrl   String?
  storyText  String?

  // Decisions (stored as JSON array)
  decisions  Json @default("[]") // [{text, targetNodeId, modalConfig, conditions}]

  // Effects (inventory/flag changes)
  effects    Json @default("[]") // [{type: 'ADD_ITEM', itemId, quantity}]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  story  Story   @relation(fields: [storyId], references: [id], onDelete: Cascade)
  branch Branch? @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@index([branchId])
  @@index([order])
  @@map("story_nodes")
}

// Branch (mellékszál)
model Branch {
  id             String     @id @default(uuid())
  storyId        String
  name           String // "Rejtélyes Ház", "Barna Szoba"
  type           BranchType @default(LOCATION)

  // Entry/Exit points
  entryNodeId    String // Mainline or parent branch node ID
  exitNodeIds    Json // ["mainline_id", "DEATH"]
  exitType       ExitType @default(NODE)

  // Nesting
  parentBranchId String?
  depth          Int @default(1) // Max 3

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  story        Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  parentBranch Branch?  @relation("NestedBranches", fields: [parentBranchId], references: [id], onDelete: Cascade)
  childBranches Branch[] @relation("NestedBranches")
  nodes        StoryNode[]

  @@index([storyId])
  @@index([parentBranchId])
  @@map("branches")
}

enum BranchType {
  LOCATION // Ház, Kastély, Erdő
  ROOM     // Szoba egy location-ben
  EVENT    // Időbeli esemény
}

enum ExitType {
  NODE  // Visszatér node-hoz
  DEATH // Halál
}

// Game session model
model GameSession {
  id        String   @id @default(uuid())
  userId    String
  storyId   String
  state     Json     // GameState object
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  story  Story  @relation(fields: [storyId], references: [id], onDelete: Cascade)

  puzzleAttempts PuzzleAttempt[]
  shopTransactions ShopTransaction[]

  @@index([userId])
  @@index([storyId])
  @@map("game_sessions")
}

// Puzzle attempt tracking
model PuzzleAttempt {
  id            String   @id @default(uuid())
  sessionId     String
  puzzleId      String
  answer        Json
  correct       Boolean
  score         Float?
  timeSpentMs   Int?
  attemptedAt   DateTime @default(now())

  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([puzzleId])
  @@map("puzzle_attempts")
}

// Shop transaction tracking
model ShopTransaction {
  id          String   @id @default(uuid())
  sessionId   String
  action      String   // "buy" or "sell"
  itemId      String
  quantity    Int
  cost        Json     // { currency_id, value }
  success     Boolean
  createdAt   DateTime @default(now())

  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("shop_transactions")
}

// Analytics event tracking
model AnalyticsEvent {
  id        String   @id @default(uuid())
  sessionId String?
  eventType String
  eventData Json?
  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([eventType])
  @@map("analytics_events")
}
