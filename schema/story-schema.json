{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "InteractiveStory",
  "description": "Aventura Game Story JSON Schema - Complete specification",
  "type": "object",
  "required": ["title", "language", "version", "nodes"],
  "properties": {
    "title": { "type": "string" },
    "language": { "type": "string" },
    "version": { "type": "string" },
    "assets": {
      "type": "array",
      "items": { "$ref": "#/definitions/MediaAsset" }
    },
    "items": {
      "type": "array",
      "items": { "$ref": "#/definitions/ItemDef" }
    },
    "currencies": {
      "type": "array",
      "items": { "$ref": "#/definitions/CurrencyDef" }
    },
    "stats": {
      "type": "array",
      "items": { "$ref": "#/definitions/StatDef" }
    },
    "nodes": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/Node" }
    }
  },
  "definitions": {
    "MediaAsset": {
      "type": "object",
      "required": ["id", "type", "src"],
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string", "enum": ["image", "video", "audio"] },
        "src": { "type": "string" },
        "alt": { "type": "string" },
        "meta": {
          "type": "object",
          "properties": {
            "width": { "type": "integer" },
            "height": { "type": "integer" },
            "duration": { "type": "number" },
            "prompt": { "type": "string" },
            "seed": { "type": "string" },
            "generator": { "type": "string" },
            "format": { "type": "string" }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "MediaRef": {
      "type": "object",
      "required": ["asset_id"],
      "properties": {
        "asset_id": { "type": "string" },
        "role": { "type": "string", "enum": ["illustration", "background", "thumb", "video", "audio"] }
      },
      "additionalProperties": false
    },
    "ItemDef": {
      "type": "object",
      "required": ["id", "name", "type", "stackable"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "type": { "type": "string" },
        "stackable": { "type": "boolean" },
        "max_stack": { "type": "integer" },
        "icon": { "type": "string" },
        "desc": { "type": "string" }
      },
      "additionalProperties": false
    },
    "CurrencyDef": {
      "type": "object",
      "required": ["id", "name"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "symbol": { "type": "string" }
      },
      "additionalProperties": false
    },
    "StatDef": {
      "type": "object",
      "required": ["id", "name", "min", "max", "start"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "min": { "type": "number" },
        "max": { "type": "number" },
        "start": { "type": "number" }
      },
      "additionalProperties": false
    },
    "Effect": {
      "type": "object",
      "required": ["op"],
      "properties": {
        "op": {
          "type": "string",
          "enum": [
            "add_item","remove_item",
            "add_currency","add_stat",
            "set_flag","log",
            "goto","unlock_choice","lock_choice",
            "set_timer","loot_table"
          ]
        },
        "item_id": { "type": "string" },
        "qty": { "type": "number" },
        "currency_id": { "type": "string" },
        "value": { "type": "number" },
        "stat_id": { "type": "string" },
        "flag": { "type": "string" },
        "message": { "type": "string" },
        "next_id": { "type": "string" },
        "node_id": { "type": "string" },
        "choice_index": { "type": "integer" },
        "timer_flag": { "type": "string" },
        "expires_in_ms": { "type": "integer" },
        "table": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["weight","effects"],
            "properties": {
              "weight": { "type": "number" },
              "effects": { "type": "array", "items": { "$ref": "#/definitions/Effect" } }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "Requirement": {
      "type": "object",
      "required": ["op"],
      "properties": {
        "op": {
          "type": "string",
          "enum": [
            "has_item","inventory_lt",
            "currency_gte","currency_lt",
            "stat_gte","stat_between",
            "flag_is",
            "puzzle_solved",
            "visited_node"
          ]
        },
        "item_id": { "type": "string" },
        "qty": { "type": "number" },
        "currency_id": { "type": "string" },
        "value": { "type": "number" },
        "min": { "type": "number" },
        "max": { "type": "number" },
        "stat_id": { "type": "string" },
        "flag": { "type": "string" },
        "puzzle_id": { "type": "string" },
        "node_id": { "type": "string" }
      },
      "additionalProperties": false
    },
    "RequirementExpr": {
      "oneOf": [
        { "$ref": "#/definitions/Requirement" },
        {
          "type": "object",
          "required": ["all_of"],
          "properties": { "all_of": { "type": "array", "items": { "$ref": "#/definitions/RequirementExpr" }, "minItems": 1 } },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["any_of"],
          "properties": { "any_of": { "type": "array", "items": { "$ref": "#/definitions/RequirementExpr" }, "minItems": 1 } },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["not"],
          "properties": { "not": { "$ref": "#/definitions/RequirementExpr" } },
          "additionalProperties": false
        }
      ]
    },
    "PuzzleCommon": {
      "type": "object",
      "required": ["id","kind","prompt"],
      "properties": {
        "id": { "type": "string" },
        "kind": {
          "type": "string",
          "enum": ["mcq","text","regex","numeric","article_de","cloze_text","matching","ordering","hotspot"]
        },
        "prompt": { "type": "string" },
        "media": { "type": "array", "items": { "$ref": "#/definitions/MediaRef" } },
        "time_limit_ms": { "type": "integer", "minimum": 1000 },
        "attempts_max": { "type": "integer", "minimum": 1 },
        "hints": { "type": "array", "items": { "type": "string" } },
        "variants": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["weight","override"],
            "properties": {
              "weight": { "type": "number" },
              "override": { "type": "object" }
            },
            "additionalProperties": false
          }
        },
        "success": {
          "type": "object",
          "properties": {
            "effects": { "type": "array", "items": { "$ref": "#/definitions/Effect" } },
            "next_id": { "type": "string" }
          },
          "additionalProperties": false
        },
        "failure": {
          "type": "object",
          "properties": {
            "effects": { "type": "array", "items": { "$ref": "#/definitions/Effect" } },
            "next_id": { "type": "string" }
          },
          "additionalProperties": false
        },
        "gate_choices_until_solved": { "type": "boolean", "default": true },
        "dynamic": {
          "type": "object",
          "properties": {
            "if_attempts_gt": { "type": "integer" },
            "give_hint_cost": { "type": "object", "properties": { "currency_id": { "type": "string" }, "value": { "type": "number" } }, "additionalProperties": false },
            "extra_time_ms": { "type": "integer" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "Choice": {
      "type": "object",
      "required": ["label","next_id"],
      "properties": {
        "label": { "type": "string" },
        "next_id": { "type": "string" },
        "requirements": { "$ref": "#/definitions/RequirementExpr" },
        "effects": { "type": "array", "items": { "$ref": "#/definitions/Effect" } },
        "disabled_reason": { "type": "string" }
      },
      "additionalProperties": false
    },
    "Node": {
      "type": "object",
      "required": ["id","part","title","text"],
      "properties": {
        "id": { "type": "string" },
        "part": { "type": "integer", "minimum": 1 },
        "type": { "type": "string", "enum": ["ending"] },
        "title": { "type": "string" },
        "text": { "type": "string" },
        "media": { "type": "array", "items": { "$ref": "#/definitions/MediaRef" } },
        "on_enter": {
          "type": "object",
          "properties": {
            "effects": { "type": "array", "items": { "$ref": "#/definitions/Effect" } }
          },
          "additionalProperties": false
        },
        "puzzle": { "type": "object" },
        "choices": { "type": "array", "items": { "$ref": "#/definitions/Choice" } }
      },
      "additionalProperties": false,
      "allOf": [
        { "if": { "properties": { "type": { "const": "ending" } }, "required": ["type"] }, "then": { "not": { "required": ["choices"] } } }
      ]
    }
  },
  "additionalProperties": false
}
